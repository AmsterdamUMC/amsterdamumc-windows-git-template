#!/bin/bash

#
#
# Additions to a pre-commit check specific for the AmsterdamUMC
#
# TODO The implementation of the JIRA-task in the order found in 
# sub-tasks of RDMR-373


# Remove all comments and empty lines from .gitignore
IGNORED_DIRECTORIES=$(cat .gitignore | grep -v -e '^[[:space:]]*$' -e '^#')




#
# Function to display a message to the user prefixed with '>> NOTE: '
#
# # Required parameters:
# $1 the messag
#
# Example:
# message "The file letter.txt contains a surname"

message() {
	echo -e ">> NOTE: $1"
} 

#echo -e ""
#echo -e "Ignored are:"
#echo "$IGNORED_DIRECTORIES"
#echo -e ""

echo -e "Performing pre-commit checks"

# shopt -s nullglobs
# for item in *; do
# 	NUMBER_OF_ITEMS_MATCHED=0;
# 	for ignored_item in $IGNORED_DIRECTORIES; do
# 		# echo "Comparing : $item with $ignored_item"
# 		if [[ "$ignored_item" == "$item"* ]]; then
# 			NUMBER_OF_ITEMS_MATCHED=$((NUMBER_OF_ITEMS_MATCHED + 1))
# 		fi
# 		if [[ $NUMBER_OF_ITEMS_MATCHED == 0 ]]; then
# 			# echo "N Matched Items: " $NUMBER_OF_ITEMS_MATCHED
# 			echo -e "Checking in $item"
# 			# Look for the surnames defined in surname.txt file. Refer to 
# 			# grep --help for the meaning of the parameters used.
# 			grep -n -w -i -d recurse --file .amsterdamumc-scripts/lookup_items/surnames.txt `echo "$item"` --colour
# 		fi
# 	done
# done


# exec -a $0 .amsterdamumc-scripts/scan-surnames.bat `echo "$ITEMS_TO_CHECK"`
# cmd /C "findstr /I /N /S /G:.lookup_items/surnames.txt * > output.txt"


# 
# Check existance .gitignore
# 
if [ -f .gitignore ]; then
	echo "OK: .gitignore present"
else
	message ".gitignore not present"
fi


# 
# Create a temporary file containing all the added (A) and modified (M) files
# in uppercase with each line containing the file name and numbered lines
#
TEMP_FILE=`mktemp`
STAGED_FILES_LIST=`git diff --name-only --cached --diff-filter=AM | tr '\n' '\t'`
echo "Checking the following files staged for commit:"
echo
for file_name in $STAGED_FILES_LIST; do
	echo "Filename: $file_name"
	awk -v filename=$file_name '{ print filename, NR,"\t", toupper($0) }' $file_name >> $TEMP_FILE
done
echo
time rg -w --regex-size-limit=2G --dfa-size-limit=2G --fixed-strings --f .amsterdamumc-scripts/lookup_items/all-search-items-upper.txt $TEMP_FILE

echo "Removing temporary file: $TEMP_FILE"
rm $TEMP_FILE
exit 0
#
# Check if excluded data directory is in .gitignore
# and if it exists on FS
#
DATA_DIR=./data
if [ -d $DATA_DIR ]; then
	echo "OK: $DATA_DIR directory present"
	if [ -f .gitignore ]; then
		
		NUMBER_MATCHES_FOUND=$(grep -c -e $DATA_DIR .gitignore)
		
		if [[ NUMBER_MATCHES_FOUND -ne 0 ]]; then
			echo "OK: Data directory found in .gitignore"
		else
			message "Data directory not present in .gitignore"
		fi
	fi
else
	message "$DATA_DIR directory not present"
fi

echo "Finished pre-commit checks"
exit 0
