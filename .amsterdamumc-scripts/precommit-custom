#!/bin/bash

#
#
# Additions to a pre-commit check specific for the AmsterdamUMC
#
# TODO The implementation of the JIRA-task in the order found in 
# sub-tasks of RDMR-373


# Remove all comments and empty lines from .gitignore
IGNORED_DIRECTORIES=$(cat .gitignore | grep -v -e '^[[:space:]]*$' -e '^#')




#
# Function to display a message to the user prefixed with '>> NOTE: '
#
# # Required parameters:
# $1 the messag
#
# Example:
# message "The file letter.txt contains a surname"

message() {
	echo -e ">> NOTE: $1"
} 

echo -e ""
echo -e "Ignored are:"
echo "$IGNORED_DIRECTORIES"
echo -e ""

echo -e "Performing pre-commit checks"

# shopt -s nullglobs
for item in *; do
	NUMBER_OF_ITEMS_MATCHED=0;
	for ignored_item in $IGNORED_DIRECTORIES; do
		# echo "Comparing : $item with $ignored_item"
		if [[ "$ignored_item" == "$item"* ]]; then
			NUMBER_OF_ITEMS_MATCHED=$((NUMBER_OF_ITEMS_MATCHED + 1))
		fi
		if [[ $NUMBER_OF_ITEMS_MATCHED == 0 ]]; then
			#echo "N Matched Items: " $NUMBER_OF_ITEMS_MATCHED
			echo -e "Checking in $item"
			exec -a $0 .amsterdamumc-scripts/scan-surnames.bat `echo "$item"`
		fi
	done
done


# exec -a $0 .amsterdamumc-scripts/scan-surnames.bat `echo "$ITEMS_TO_CHECK"`
# cmd /C "findstr /I /N /S /G:.lookup_items/surnames.txt * > output.txt"

exit 777

# 
# Check existance .gitignore
# 
if [ -f .gitignore ]; then
	echo "OK: .gitignore present"
else
	message ".gitignore not present"
fi

#
# Check if excluded data directory is in .gitignore
# and if it exists on FS
# 
if [ -d $DATA_DIR ]; then
	echo "OK: $DATA_DIR directory present"
	if [ -f .gitignore ]; then
		
		NUMBER_MATCHES_FOUND=$(grep -c -e $DATA_DIR .gitignore)
		
		if [[ NUMBER_MATCHES_FOUND -ne 0 ]]; then
			echo "OK: Private / confidential data directory found in .gitignore"
		else
			message "Private / confidential data-directory not present in .gitignore"
		fi
	fi
else
	message "$DATA_DIR directory not present"
fi

#
# Scan the all underlying directories and the top directory (except the 
# DATA_DIR) for files containing surnames. Based on the files from the
# DEDUCE project: https://github.com/vmenger/deduce/tree/main/deduce/data/lookup/src/names 
# Publication: http://www.sciencedirect.com/science/article/pii/S0736585316307365 
#
# The follwing surnames have been removed to eliminate false-positive warning 
# messages:

exit 777
echo "Finished pre-commit checks"
